#!/bin/sh
compileexecutable(){
	aarch64-linux-gnu-g++ -std=c++17 -g -Wall -I./include/* -I/usr/local/include/include/ -L/usr/local/lib ./src/*.cpp -lm -lz -lpthread -lkipr -o ./bin/botball_user_program
}
compilelibrary(){
	aarch64-linux-gnu-g++ -std=c++17 -g -Wall -fPIC -shared \
    -I./include/* -I/usr/local/include/include/ -L/usr/local/lib \
    ./src/*.cpp -lm -lz -lpthread -lkipr -o ./bin/libeden.so
}
dockerwombat() {
	sudo mkdir -p develop
	sudo mkdir -p bin
	sudo cp -r bin src include data LICENSE.txt project.manifest README.md develop/
	if [[ "$1" == "lib" ]]; then
		sudo docker run -it --rm --volume ./develop:/home/kipr:rw sillyfreak/wombat-cross sh -c ". ./data/shfuncs && compilelibrary"
		sudo cp -r develop/bin/libeden.so bin/
	else
		sudo docker run -it --rm --volume ./develop:/home/kipr:rw sillyfreak/wombat-cross sh -c ". ./data/shfuncs && compileexecutable"
		sudo cp -r develop/bin/botball_user_program bin/
	fi
	sudo rm -rf develop
}
copy() {
	ping -c 1 192.168.125.1 > /dev/null || { echo "Host unreachable"; return 1; }
	if scp -r -q * "kipr@192.168.125.1:~/Documents/KISS/$1"; then
		return 0;
	else
	return 1;
	fi
}

shell() {
	ssh kipr@192.168.125.1
}

compile() {
	if [ -z "$2" ]; then
		echo "No destination specified.";
		return 1;
	fi
	echo "Compiling...";
	if dockerwombat "$1"; then
		if [[ "$2" != "--nocopy" ]]; then
			if copy "$2"; then
				echo -n "Succeeded at: "
			else
				echo -n "Copy failed at: "
			fi
		else
			echo -n "Compilation succeeded at: "
		fi
	else
		[ -d develop ] && rm -r develop
		echo -n "Compilation failed at: "
	fi
	date +"%r"
}
